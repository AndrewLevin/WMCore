#!/usr/bin/env python
"""
_outputmodules-from-config_

Pull output module metadata from a CMSSW config.
"""

import sys
import tempfile
import os
import urllib
import imp

from WMCore.Wrappers.JsonWrapper import JSONEncoder, JSONDecoder

def loadConfig(configPath):
    """
    _loadConfig_

    Import a config.
    """
    cfgBaseName = os.path.basename(configPath).replace(".py", "")
    cfgDirName = os.path.dirname(configPath)
    modPath = imp.find_module(cfgBaseName, [cfgDirName])
    
    loadedConfig = imp.load_module(cfgBaseName, modPath[0],
                                   modPath[1], modPath[2])
    
    return loadedConfig

def outputModulesFromConfig(configHandle):
    """
    _outputModulesFromConfig_

    Go through all the output modules in a config and extract the meta data.
    """
    outputModules = {}
    for outputModuleName in configHandle.outputModules.keys():
        outputModule = getattr(configHandle, outputModuleName)
        outputModules[outputModuleName] = {}
        if hasattr(outputModule, "dataset"):
            dataTierAttr = getattr(outputModule.dataset, "dataTier", None)
            filterNameAttr = getattr(outputModule.dataset, "filterName", None)

            dataTier = None
            filterName = None
            if dataTierAttr:
                dataTier = dataTierAttr.value()
            if filterNameAttr:
                filterName = filterNameAttr.value()
                
            outputModules[outputModuleName] = {"dataTier": dataTier,
                                               "filterName": filterName}
            
    return outputModules

if __name__ == "__main__":
    try:
        jsonDecoder = JSONDecoder()
        jsonEncoder = JSONEncoder()

        encodedConfig = sys.stdin.readline()
        config = jsonDecoder.decode(encodedConfig)

        if config.get("configUrl", None):
            tempDir = tempfile.mkdtemp()
            configPath = os.path.join(tempDir, "cmsswConfig.py")
            compConfigPath = os.path.join(tempDir, "cmsswConfig.pyc")
            configString = urllib.urlopen(config["configUrl"]).read(-1)
            configFile = open(configPath, "w")
            configFile.write(configString)
            configFile.close()
            process = loadConfig(configPath).process
            os.remove(configPath)
            os.remove(compConfigPath)
            os.rmdir(tempDir)
        else:
            from WMCore.WMRuntime.Scripts.SetupCMSSWPset import SetupCMSSWPset
            mySetup = SetupCMSSWPset()
            mySetup.createProcess(config["scenarioName"], config["scenarioFunc"],
                                  config["scenarioArgs"])
            process = mySetup.process

        outputModules = outputModulesFromConfig(process)
        outputModulesJSON = jsonEncoder.encode(outputModules)

        outputHandle = open("outputModules.json", "w")
        outputHandle.write("%s\n" % outputModulesJSON)
        outputHandle.close()
        
        sys.exit(0)
    except Exception, ex:
        print ex
        sys.exit(1)
