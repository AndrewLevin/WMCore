<html>
  <head>
    <title>WMStats</title>
    <style type="text/css" title="currentStyle">
            @import "css/demo_table.css";
    </style>
    <script src="lib/namespace.js" type='text/javascript'> </script>
    <script src="lib/jquery.js" type='text/javascript'> </script>
    <script src="lib/jquery.dataTables.js" type='text/javascript'> </script>
    <script src="lib/ColVis.js" type='text/javascript'> </script>
    <script src="lib/jquery.dataTables.columnFilter.js" type='text/javascript'> </script>
    <script src="js/WMStats.Table.js" type='text/javascript'> </script>
    <script src="js/WMStats.Requests.js" type='text/javascript'> </script>
    <script src="js/WMStats.Globals.js" type='text/javascript'> </script>
    <script>
    
    $.post = function(url, data, func, dataType) {
        $.ajax({"url": url,
                "type": "POST",
                "data": data,
                "contentType": "application/json; charset=utf-8",
                "dataType": dataType,
                "success": func
               })
           }

    var requestTableConfig = {
        "aoColumns": [
            { "mDataProp": "agent_url", "sTitle": "agent"},
            { "mDataProp": "site", "sTitle": "site"},
            { "mDataProp": "queued.first", "sTitle": "queued first", "sDefaultContent": 0 },
            { "mDataProp": "queued.retry", "sTitle": "queued retry", "sDefaultContent": 0 },
            { "mDataProp": "submitted.first", "sTitle": "submitted first", "sDefaultContent": 0 },
            { "mDataProp": "submitted.retry", "sTitle": "submitted retry", "sDefaultContent": 0 },
            { "mDataProp": "submitted.pending", "sTitle": "submitted pending", "sDefaultContent": 0 },
            { "mDataProp": "submitted.running", "sTitle": "submitted running", "sDefaultContent": 0 },
            { "mDataProp": "failure.create", "sTitle": "create fail", "sDefaultContent": 0 },
            { "mDataProp": "failure.submit", "sTitle": "submit fail", "sDefaultContent": 0 },
            { "mDataProp": "failure.exception", "sTitle": "exception fail", "sDefaultContent": 0 },
            { "mDataProp": "canceled", "sTitle": "canceled", "sDefaultContent": 0 },
            { "mDataProp": "success", "sTitle": "success", "sDefaultContent": 0 },
            { "mDataProp": "cooloff", "sTitle": "cool off", "sDefaultContent": 0 },
            { "mDataProp": "timestamp", "sTitle": "updated"}
            //TODO add more data
        ]
    }

    var convertSiteData = function(data, baseColumns) {
        var rows =[]
        for (var i in data) {
            tableRow = data[i].value;
            for (var j = 0; j < baseColumns.length; j ++) {
                tableRow[baseColumns[j]] = data[i].key[j];
            }
            rows.push(tableRow)
        }
        return rows
    }
    
    var createSiteTable = function(selector, data) {
        var baseCols = ["timestamp", "agent_url", "site"];
        requestTableConfig.aaData = convertSiteData(data, baseCols);
        return WMStats.Table(requestTableConfig).create(selector)
    }
    
    var keysFromIDs = function(data) {
        var keys = [];
        for (var i in data.rows){
            keys.push([data.rows[i].value, data.rows[i].key[0], data.rows[i].key[1]]);
        }
        return JSON.stringify(keys);      
    }   
                
    
    var getLatestRequestIDsAndCreateTable = function (reqmgrData) {
        /*
         * get list of request ids first from the couchDB then get the details of the requests.
         * This is due to the reduce restiction on couchDB - can't be one http call. 
         */

        var options = {"keys": keysFromIDs(reqmgrData), "reduce": true, 
                       "group": true};
        //TODO need to change to post call
        var url = WMStats.Globals.couchDBViewPath + 'agent-site';
        $.get(url, options,
              function(agentIDs) {
                  return createSiteTable("#requestTable", agentIDs.rows)
              },
              'json')
    }
      
    $(document).ready(function() {
          
        $('#requestDiv').html( '<table cellpadding="0" cellspacing="0" border="0" class="display" id="requestTable"></table>' );
        var url = WMStats.Globals.couchDBViewPath + 'latest-agent-time';
        var options = {"reduce": true, "group_level": 2, "descending": true};
        $.get(url, options,
              function(reqmgrData) {
                  getLatestRequestIDsAndCreateTable(reqmgrData)
              },
              'json')
        
     } );
    </script>
<body>
    <div id="requestDiv"></div>
</body>