<html>
  <head>
    <title>WMStats</title>
    <style type="text/css" title="currentStyle">
            @import "css/demo_table.css";
    </style>
    <script src="lib/namespace.js" type='text/javascript'> </script>
    <script src="lib/jquery.js" type='text/javascript'> </script>
    <script src="lib/jquery.dataTables.js" type='text/javascript'> </script>
    <script src="js/WMStats.Table.js" type='text/javascript'> </script>
    <script src="js/WMStats.Requests.js" type='text/javascript'> </script>
    <script>
    
    $.jsonpost = function(url, data, func, dataType) {
        $.ajax({"url": url,
                "type": "POST",
                "data": data,
                "contentType": "application/json; charset=utf-8",
                "dataType": dataType,
                "success": func
               })
           }
           
      /*
   statusObj structure
  statusObj = {
    "queued": {"first": 0, "retry": 0},
    "submitted": {"first": 0, "retry": 0, "pending": 0, "running": 0},
    "failure": {"create": 0, "submit": 0, "exception": 0},
    "canceled": 0,
    "success": 0,
    "cooloff": 0
    }
  */

    var requestTableConfig = {
        "aoColumns": [
            { "mDataProp": "workflow", "sTitle": "workflow"},
            { "mDataProp": "requestor", "sTitle": "requestor"},
            { "mDataProp": "request_type", "sTitle": "type"},
            { "mDataProp": "inputdataset", "sTitle": "inputdataset"},
            { "mDataProp": "site_white_list", "sTitle": "site white list"},
            { "mDataProp": "status.inWMBS", "sTitle": "in wmbs", "sDefaultContent": 0},
            { "mDataProp": "status.queued.first", "sTitle": "queued first", "sDefaultContent": 0 },
            { "mDataProp": "status.queued.retry", "sTitle": "queued retry", "sDefaultContent": 0 },
            { "mDataProp": "status.submitted.first", "sTitle": "submitted first", "sDefaultContent": 0 },
            { "mDataProp": "status.submitted.retry", "sTitle": "submitted retry", "sDefaultContent": 0 },
            { "mDataProp": "status.submitted.pending", "sTitle": "submitted pending", "sDefaultContent": 0 },
            { "mDataProp": "status.submitted.running", "sTitle": "submitted running", "sDefaultContent": 0 },
            { "mDataProp": "status.failure.create", "sTitle": "create fail", "sDefaultContent": 0 },
            { "mDataProp": "status.failure.submit", "sTitle": "submit fail", "sDefaultContent": 0 },
            { "mDataProp": "status.failure.exception", "sTitle": "exception fail", "sDefaultContent": 0 },
            { "mDataProp": "status.canceled", "sTitle": "canceled", "sDefaultContent": 0 },
            { "mDataProp": "status.success", "sTitle": "success", "sDefaultContent": 0 },
            { "mDataProp": "status.cooloff", "sTitle": "cool off", "sDefaultContent": 0 },
            
            { "mDataProp": "total_jobs", "sTitle": "total estimate jobs", "sDefaultContent": 0 },
            //TODO add more data
        ]
    }

    var keysFromIDs = function(data) {
        var keys = [];
        for (var i in data.rows){
            keys.push(data.rows[i].id);
        }
        return keys;      
    }   
                
    var getRequestDetailsAndCreateTable = function (agentIDs, reqmgrData) {
        var options = {'keys': keysFromIDs(agentIDs), 'reduce': false, 'include_docs': true};
        //TODO need to change to post call
        $.get('/mock_wmstats/_design/WMStats/_view/latest-request', options,
              function(agentData) {
                  var requestCache = WMStats.Requests()
                  requestCache.updateBulkRequests(reqmgrData.rows)
                  requestCache.updateBulkRequests(agentData.rows)
                  
                  requestTableConfig.aaData = requestCache.getList();
                  return $("#requestTable").dataTable(requestTableConfig);
                  //WMStats.Table.create("#requestTable", combinedData);
              },
              'json')
    }
    
    var getLatestRequestIDsAndCreateTable = function (reqmgrData) {
        /*
         * get list of request ids first from the couchDB then get the details of the requests.
         * This is due to the reduce restiction on couchDB - can't be one http call. 
         */

        var options = {"keys": keysFromIDs(reqmgrData), "reduce": true, 
                       "group": true, "descending": true};
        //TODO need to change to post call
        $.get('/mock_wmstats/_design/WMStats/_view/latest-request', options,
              function(agentIDs) {
                  getRequestDetailsAndCreateTable(agentIDs, reqmgrData)
              },
              'json')
    }
      
    $(document).ready(function() {
          
        $('#requestDiv').html( '<table cellpadding="0" cellspacing="0" border="0" class="display" id="requestTable"></table>' );
      
        $.get('/mock_wmstats/_design/WMStats/_view/campaign-request', 'include_docs=true',
              function(reqmgrData) {
                  getLatestRequestIDsAndCreateTable(reqmgrData)
              },
              'json')
        
     } );
    </script>
<body>
    <div id="requestDiv"></div>
</body>