<html>
  <head>
    <title>WMStats</title>
    <style type="text/css" title="currentStyle">
            @import "css/demo_table.css";
    </style>
    <script src="lib/namespace.js" type='text/javascript'> </script>
    <script src="lib/jquery.js" type='text/javascript'> </script>
    <script src="lib/jquery.dataTables.js" type='text/javascript'> </script>
    <script src="js/WMStats.Table.js" type='text/javascript'> </script>
    <script src="js/WMStats.Requests.js" type='text/javascript'> </script>
    <script>
    
    var keysFromIDs = function(data) {
        var keys = [];
        for (var i in data.rows){
            keys.push(data.rows[i].id);
        }
        return keys;      
    }   
                
    var getRequestDetailsAndCreateTable = function (agentIDs, reqmgrData) {
        var options = {'keys': keysFromIDs(agentIDs), 'reduce': false, 'include_docs': true};
        
        $.post('/wmstats/_design/WMStats/_view/latest-request', options,
              function(agentData) {
                  var requestCache = WMStats.Requests()
                  requestCache.updateBulkRequests(reqmgrData.rows)
                  requestCache.updateBulkRequests(agentData.rows)
                  WMStats.Table.create("#requestTable", combinedData);
              },
              'json')
    }
    
    var getLatestRequestIDsAndCreateTable = function (reqmgrData) {
        /*
         * get list of request ids first from the couchDB then get the details of the requests.
         * This is due to the reduce restiction on couchDB - can't be one http call. 
         */
        var options = {'keys': keysFromIDs(response), 'reduce': true, 'group': true};
                  
        $.post('/wmstats/_design/WMStats/_view/latest-request', options,
              function(agentIDs) {
                  getRequestDetailsAndCreateTable(agentIDs, reqmgrData)
              },
              'json')
    }
      
    $(document).ready(function() {
          
        $('#requestDiv').html( '<table cellpadding="0" cellspacing="0" border="0" class="display" id="requestTable"></table>' );
      
        $.get('/wmstats/_design/WMStats/_view/campaign-request', 'include_docs=true',
              function(reqmgrData) {
                  getLatestRequestIDsAndCreateTable(reqmgrData)
              },
              'json')
        
     } );
    </script>
<body>
    <div id="requestDiv"></div>
</body>